# ------------------------------------------------------------
# Universal Nginx default site configuration
# Works for all Dreblow-hosted sites in Docker
# - Handles www and non-www versions
# - Serves favicon consistently
# - Provides static caching and PHP support
# - SEO and Google Search Console friendly
# ------------------------------------------------------------

# Redirect bare domain â†’ www domain for SEO canonicalization
server {
    listen 80;
    server_name ~^(?!www\.)(?<domain>.+)$;
    return 308 https://www.$domain$request_uri;
}

# Primary site block for www.*
server {
    listen 80;
    server_name ~^www\.(?<domain>.+)$;

    # Serve content from the standard location
    root /var/www/html;
    index index.php index.html;

    # Static asset caching
    location ~* \.(?:jpg|jpeg|gif|png|ico|css|js|svg|woff2?|ttf|html)$ {
        expires 30d;
        add_header Cache-Control "public, no-transform";
        try_files $uri =404;
    }

    # PHP handling
    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/var/run/php/php8.1-fpm.sock; # Adjust for your PHP version
    }

    # Security headers
    add_header X-Content-Type-Options "nosniff";
    add_header X-Frame-Options "SAMEORIGIN";
    add_header Referrer-Policy "no-referrer-when-downgrade";

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css application/javascript application/json image/svg+xml;
}